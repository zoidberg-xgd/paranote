var ParaNoteEmbed=(()=>{(function(){let E=document.currentScript;if(!E)return;console.log("ParaNote: Script loaded");let A=E.dataset.siteId||"default-site",v=E.getAttribute("data-api-base");v===null&&(v=E.src&&new URL(E.src).origin.replace(/\/$/,"")||"");function W(){let h=document.querySelector("[data-na-root]");if(console.log("ParaNote: Checking root...",h),!h){console.log("ParaNote: Root not found, waiting for DOMContentLoaded..."),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",W):console.warn("ParaNote: DOM loaded but root still missing");return}if(h.dataset.paranoteInitialized){console.log("ParaNote: Already initialized");return}h.dataset.paranoteInitialized="true";let j=h.dataset.workId||"default-work",R=h.dataset.chapterId||h.dataset.ChapterId||"default-chapter",f=h.querySelectorAll("p");if(console.log(`ParaNote: Found ${f.length} paragraphs`),!f.length){console.warn("ParaNote: No paragraphs found in root");return}let p=null,u=window.innerWidth<=768||"ontouchstart"in window,C=document.createElement("div");C.className="na-overlay",Object.assign(C.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0,0,0,0.5)",zIndex:99998,display:"none"}),C.onclick=function(){y.container.style.display="none",C.style.display="none"},document.body.appendChild(C);let y=F();document.body.appendChild(y.container);function F(){let t=document.createElement("div");t.className="na-sidebar";let e={bg:"#f7f7f7",cardBg:"#ffffff",text:"#333",meta:"#707070",border:"#dbdbdb",primary:"#bd1c2b",shadow:"0 4px 12px rgba(0,0,0,0.15)"},r=document.createElement("style");r.textContent=`
            @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
            @keyframes slideLeft { from { transform: translateX(100%); } to { transform: translateX(0); } }
        `,document.head.appendChild(r),u?Object.assign(t.style,{position:"fixed",bottom:"0",left:"0",right:"0",width:"100%",maxHeight:"85vh",background:e.bg,borderTop:`1px solid ${e.border}`,borderTopLeftRadius:"12px",borderTopRightRadius:"12px",boxShadow:"0 -4px 20px rgba(0,0,0,0.15)",fontSize:"14px",display:"none",flexDirection:"column",zIndex:99999,overflow:"hidden",fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif",animation:"slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)"}):Object.assign(t.style,{position:"fixed",top:"0",right:"0",width:"380px",height:"100vh",background:e.bg,borderLeft:`1px solid ${e.border}`,boxShadow:"-2px 0 12px rgba(0,0,0,0.05)",fontSize:"14px",display:"none",flexDirection:"column",zIndex:99999,overflow:"hidden",fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif",animation:"slideLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1)"});let n=document.createElement("div");Object.assign(n.style,{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 16px",borderBottom:`1px solid ${e.border}`,background:e.cardBg,color:e.text,flexShrink:0});let s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="8px";let d=document.createElement("span");d.innerHTML="\u{1F4DD}";let a=document.createElement("span");a.textContent="Annotations",a.style.fontWeight="600",a.style.fontSize="15px";let g=document.createElement("span");g.className="na-comment-header-count",Object.assign(g.style,{background:"#eee",color:"#666",padding:"2px 8px",borderRadius:"10px",fontSize:"12px",fontWeight:"500"}),s.append(d,a,g),n.appendChild(s);let o=document.createElement("button");o.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',Object.assign(o.style,{background:"transparent",border:"none",cursor:"pointer",color:"#999",padding:"4px",display:"flex",borderRadius:"4px",transition:"background 0.2s"}),o.onmouseenter=()=>o.style.background="#f0f0f0",o.onmouseleave=()=>o.style.background="transparent",o.onclick=function(){t.style.display="none",C.style.display="none"},n.appendChild(o);let b=document.createElement("div");Object.assign(b.style,{padding:"16px",flex:"1",overflowY:"auto",background:"#f7f7f7",display:"flex",flexDirection:"column",gap:"12px"});let k=document.createElement("div");Object.assign(k.style,{padding:"16px",borderTop:`1px solid ${e.border}`,background:e.cardBg,flexShrink:0});let l=document.createElement("textarea");l.placeholder="\u6DFB\u52A0\u8BC4\u8BBA...",Object.assign(l.style,{width:"100%",minHeight:"80px",boxSizing:"border-box",padding:"12px",border:`1px solid ${e.border}`,borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",resize:"vertical",outline:"none",transition:"border-color 0.2s, box-shadow 0.2s",marginBottom:"10px"}),l.onfocus=()=>{l.style.borderColor=e.primary,l.style.boxShadow="0 0 0 2px rgba(189, 28, 43, 0.1)"},l.onblur=()=>{l.style.borderColor=e.border,l.style.boxShadow="none"};let T=document.createElement("div");T.style.display="flex",T.style.justifyContent="flex-end";let c=document.createElement("button");return c.textContent="\u53D1\u5E03",Object.assign(c.style,{padding:"8px 20px",border:"none",background:e.primary,color:"#fff",cursor:"pointer",borderRadius:"20px",fontSize:"14px",fontWeight:"600",transition:"opacity 0.2s",boxShadow:"0 2px 4px rgba(189, 28, 43, 0.3)"}),c.onmouseenter=()=>c.style.opacity="0.9",c.onmouseleave=()=>c.style.opacity="1",c.onclick=async function(){let I=l.value.trim();if(!I||p==null)return;let z=(f[p]?B(f[p]):"").slice(0,32);try{c.textContent="\u53D1\u9001\u4E2D...",c.disabled=!0;let w={"Content-Type":"application/json"};typeof window<"u"&&window.PARANOTE_TOKEN&&(w["X-Paranote-Token"]=window.PARANOTE_TOKEN),await fetch(v+"/api/v1/comments",{method:"POST",headers:w,body:JSON.stringify({siteId:A,workId:j,chapterId:R,paraIndex:p,content:I,contextText:z})}),l.value="",await M(),S(),await H(p,b,y.headerCount)}catch(w){console.error("post comment failed",w),alert("\u53D1\u9001\u5931\u8D25")}finally{c.textContent="\u53D1\u5E03",c.disabled=!1}},T.appendChild(c),k.append(l,T),t.append(n,b,k),{container:t,list:b,headerCount:g}}function B(t){if(!t)return"";let e=t.cloneNode(!0),r=e.querySelector(".na-comment-count");return r&&r.remove(),e.textContent.trim()}let L=null;function J(t){let e={},r=[];return Object.values(t).forEach(n=>r.push(...n)),r.forEach(n=>{let s=n.paraIndex;if(n.contextText&&!B(f[s]).startsWith(n.contextText)){let g=-1;for(let o=0;o<f.length;o++)if(B(f[o]).startsWith(n.contextText)){g=o;break}g!==-1&&(s=g)}let d=String(s);e[d]||(e[d]=[]),e[d].push(n)}),e}async function M(){try{let t=v+"/api/v1/comments?siteId="+encodeURIComponent(A)+"&workId="+encodeURIComponent(j)+"&chapterId="+encodeURIComponent(R),r=await(await fetch(t)).json();return L=J(r.commentsByPara||{}),L}catch(t){return console.error("load comments failed",t),{}}}function X(t){try{let r=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(window.atob(r).split("").map(function(s){return"%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(n)}catch{return null}}async function H(t,e,r){let n=(L||{})[String(t)]||[];e.innerHTML="";let s=!1,d=null;if(typeof window<"u"&&window.PARANOTE_TOKEN){d=window.PARANOTE_TOKEN;let a=X(d);a&&(a.role==="admin"||a.isAdmin===!0)&&(s=!0)}if(r&&(r.textContent=n.length>0?n.length+"\u6761":""),!n.length){let a=document.createElement("div");a.style.cssText="padding: 60px 20px; text-align: center; color: #999; font-size: 13px; background: #fff;",a.innerHTML='<div style="margin-bottom: 8px; font-size: 32px; opacity: 0.5;">\u{1F4AC}</div><div>\u8FD8\u6CA1\u6709\u4EBA\u53D1\u8868\u8BC4\u8BBA</div>',e.appendChild(a);return}n.forEach(function(a,g){let o=document.createElement("div");o.className="na-comment-card",Object.assign(o.style,{padding:"12px",marginBottom:"0",background:"#fff",borderRadius:"8px",border:"1px solid #eee",boxShadow:"0 1px 3px rgba(0,0,0,0.05)",transition:"transform 0.2s, box-shadow 0.2s",position:"relative"}),u||(o.addEventListener("mouseenter",()=>{o.style.transform="translateY(-1px)",o.style.boxShadow="0 4px 8px rgba(0,0,0,0.08)"}),o.addEventListener("mouseleave",()=>{o.style.transform="none",o.style.boxShadow="0 1px 3px rgba(0,0,0,0.05)"}));let b=document.createElement("div");b.style.cssText="display: flex; align-items: center; margin-bottom: 8px;";let k=document.createElement("div"),l=a.userName||a.userId||"\u533F\u540D",T=l.length>0?l.charAt(0).toUpperCase():"?",c=0;for(let i=0;i<l.length;i++)c=l.charCodeAt(i)+((c<<5)-c);let I=c%360;k.style.cssText=`
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: hsl(${I}, 60%, 85%);
            color: hsl(${I}, 60%, 30%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 10px;
            flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.05);
          `,k.textContent=T;let O=document.createElement("div");O.style.cssText="flex: 1; min-width: 0; display: flex; flex-direction: column;";let z=document.createElement("span");z.style.cssText="font-weight: 600; color: #333; font-size: 13px;",z.textContent=l;let w=document.createElement("span");w.style.cssText="font-size: 11px; color: #999; margin-top: 2px;";let _=a.createdAt?new Date(a.createdAt).toLocaleString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"";w.textContent=_,O.appendChild(z),O.appendChild(w),b.appendChild(k),b.appendChild(O);let N=document.createElement("div");N.style.cssText="color: #444; font-size: 14px; line-height: 1.6; word-break: break-word; padding-left: 42px;";let U=a.content;if(U.startsWith("> ")){let i=U.split(`
`),x=i[0].substring(2),D=i.slice(1).join(`
`).trim(),$=document.createElement("div");$.style.cssText="border-left: 3px solid #bd1c2b; padding-left: 8px; color: #777; margin-bottom: 6px; font-size: 13px; background: #f9f9f9; padding: 4px 8px; border-radius: 0 4px 4px 0;",$.textContent=x,N.appendChild($);let q=document.createElement("div");q.textContent=D,N.appendChild(q)}else N.textContent=U;let P=document.createElement("div");if(P.style.cssText="display: flex; justify-content: flex-end; align-items: center; margin-top: 8px; padding-left: 42px;",s){let i=document.createElement("button");i.innerHTML="\u{1F5D1}\uFE0F",i.title="\u5220\u9664",i.style.cssText="border:none; background:transparent; cursor:pointer; color:#aaa; font-size:14px; margin-right: 12px; transition:color 0.2s;",i.onmouseenter=()=>i.style.color="#bd1c2b",i.onmouseleave=()=>i.style.color="#aaa",i.onclick=async function(){if(confirm("\u786E\u5B9A\u5220\u9664\u8FD9\u6761\u8BC4\u8BBA\u5417\uFF1F"))try{let x={"Content-Type":"application/json"};d&&(x["X-Paranote-Token"]=d),(await fetch(v+"/api/v1/comments",{method:"DELETE",headers:x,body:JSON.stringify({siteId:A,workId:j,chapterId:R,commentId:a.id})})).ok?(await M(),S(),await H(t,e,r)):alert("\u5220\u9664\u5931\u8D25")}catch(x){console.error(x)}},P.appendChild(i)}let m=document.createElement("button"),K=a.likes||0;m.innerHTML=`<span style="font-size:14px">\u2764\uFE0F</span> <span style="margin-left:4px; font-size:12px;">${K||""}</span>`,m.style.cssText="border:none; background:transparent; cursor:pointer; color:#aaa; display:flex; align-items:center; padding: 2px 6px; transition:color 0.2s; border-radius:4px;",m.onmouseenter=()=>{m.style.color="#bd1c2b",m.style.background="#fff0f0"},m.onmouseleave=()=>{m.style.color="#aaa",m.style.background="transparent"},m.onclick=async function(){try{let i={"Content-Type":"application/json"};d&&(i["X-Paranote-Token"]=d);let x=await fetch(v+"/api/v1/comments/like",{method:"POST",headers:i,body:JSON.stringify({siteId:A,workId:j,chapterId:R,commentId:a.id})});if(x.status===401)return alert("\u8BF7\u767B\u5F55\u540E\u518D\u70B9\u8D5E");if(x.status===400)return alert("\u60A8\u5DF2\u7ECF\u70B9\u8FC7\u8D5E\u4E86");if(x.ok){let D=await x.json();m.innerHTML=`<span style="font-size:14px">\u2764\uFE0F</span> <span style="margin-left:4px; font-weight:bold; color:#bd1c2b">${D.likes}</span>`,m.style.color="#bd1c2b"}}catch(i){console.error(i)}},P.appendChild(m),o.appendChild(b),o.appendChild(N),o.appendChild(P),e.appendChild(o)})}function S(){f.forEach(function(t,e){let r=(L||{})[String(e)]?.length||0,n=t.querySelector(".na-comment-count");n||(n=document.createElement("span"),n.className="na-comment-count",t.appendChild(n));let s=p===e,d=s?"#f56c6c":"#999",a=s?"#f56c6c":"#e0e0e0";Object.assign(n.style,{display:"inline-block",marginLeft:u?"8px":"6px",padding:"0 4px",fontSize:u?"11px":"10px",color:d,background:"#fff",border:`1px solid ${a}`,borderRadius:"2px",cursor:"pointer",fontWeight:"500",minWidth:"18px",height:"18px",lineHeight:"16px",textAlign:"center",verticalAlign:"middle",touchAction:"manipulation",transition:"all 0.15s ease",boxSizing:"border-box"}),n.textContent=r,n.title=r+" \u6761\u8BC4\u8BBA",n.style.fontSize=u?"11px":"10px",u||(n.onmouseenter=function(){n.style.borderColor="#f56c6c",n.style.color="#f56c6c"},n.onmouseleave=function(){n.style.borderColor=a,n.style.color=d})})}f.forEach(function(t,e){t.dataset.naIndex=String(e),Object.assign(t.style,{cursor:"pointer",position:"relative",padding:u?"8px 0":"4px 0",borderRadius:"4px",transition:"all 0.2s",WebkitTapHighlightColor:"transparent",touchAction:"manipulation"}),u||(t.addEventListener("mouseenter",function(){p!==e&&(t.style.background="rgba(0, 0, 0, 0.02)")}),t.addEventListener("mouseleave",function(){p!==e&&(t.style.background="transparent",t.style.textDecoration="none")}));let r=async function(n){if(p!==null&&f[p]&&(f[p].style.textDecoration="none",f[p].style.background="transparent"),p===e&&y.container.style.display!=="none"){p=null,S(),y.container.style.display="none",u&&(C.style.display="none");return}p=e,t.style.textDecoration="underline",t.style.textDecorationColor="#f56c6c",t.style.textDecorationThickness=u?"2px":"1.5px",t.style.textUnderlineOffset="2px",t.style.background="transparent",S(),y.container.style.display="flex",u&&(C.style.display="block",y.container.scrollTop=0),await H(e,y.list,y.headerCount)};t.onclick=r,u&&t.addEventListener("touchend",function(n){},{passive:!1})}),M().then(function(){S()})}W()})();})();
