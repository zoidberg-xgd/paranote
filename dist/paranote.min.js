var ParaNoteEmbed=(()=>{(function(){let w=document.currentScript;if(!w)return;let S=w.dataset.siteId||"default-site",v=w.dataset.apiBase||w.src&&new URL(w.src).origin.replace(/\/$/,"")||"",E=document.querySelector("[data-na-root]");if(!E||!v)return;let z=E.dataset.workId||"default-work",O=E.dataset.chapterId||E.dataset.ChapterId||"default-chapter",k=E.querySelectorAll("p");if(!k.length)return;let p=null,t=window.innerWidth<=768||"ontouchstart"in window,y=document.createElement("div");y.className="na-overlay",Object.assign(y.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0,0,0,0.5)",zIndex:99998,display:"none"}),y.onclick=function(){h.container.style.display="none",y.style.display="none"},document.body.appendChild(y);let h=D();document.body.appendChild(h.container);function D(){let e=document.createElement("div");e.className="na-sidebar",t?Object.assign(e.style,{position:"fixed",bottom:"0",left:"0",right:"0",width:"100%",maxHeight:"80vh",background:"#fff",borderTop:"1px solid #eee",borderTopLeftRadius:"16px",borderTopRightRadius:"16px",boxShadow:"0 -2px 16px rgba(0,0,0,0.2)",fontSize:"14px",display:"none",flexDirection:"column",zIndex:99999,overflow:"hidden"}):Object.assign(e.style,{position:"fixed",top:"100px",right:"20px",width:"340px",maxHeight:"calc(100vh - 120px)",background:"#fff",border:"1px solid #e5e5e5",borderRadius:"4px",boxShadow:"0 2px 12px rgba(0,0,0,0.1)",fontSize:"14px",display:"none",flexDirection:"column",zIndex:99999,overflow:"hidden"});let o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center",Object.assign(o.style,{padding:t?"14px 16px":"12px 16px",borderBottom:"1px solid #e5e5e5",background:"#fafafa",fontWeight:"500",fontSize:t?"15px":"14px",color:"#333"});let s=document.createElement("div");s.style.display="flex",s.style.alignItems="center";let n=document.createElement("span");n.textContent="\u8BC4\u8BBA",n.style.fontWeight="500";let c=document.createElement("span");c.className="na-comment-header-count",c.style.color="#999",c.style.fontSize=t?"13px":"12px",c.style.fontWeight="400",c.style.marginLeft="6px",s.appendChild(n),s.appendChild(c),o.appendChild(s);let a=document.createElement("button");a.innerHTML="\xD7",Object.assign(a.style,{background:"transparent",border:"none",fontSize:t?"24px":"22px",cursor:"pointer",color:"#999",padding:"0",width:t?"28px":"26px",height:t?"28px":"26px",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"2px",transition:"all 0.15s",lineHeight:"1"}),a.onmouseenter=function(){a.style.background="#e8e8e8",a.style.color="#666"},a.onmouseleave=function(){a.style.background="transparent",a.style.color="#999"},a.onclick=function(){e.style.display="none",y.style.display="none"},o.appendChild(a);let i=document.createElement("div");Object.assign(i.style,{padding:"0",flex:"1",overflowY:"auto",minHeight:t?"200px":"100px",background:"#fff"});let d=document.createElement("textarea");Object.assign(d.style,{width:"100%",height:t?"80px":"60px",boxSizing:"border-box",margin:t?"8px 16px 4px":"4px 12px",padding:"8px",border:"1px solid #ddd",borderRadius:"4px",fontSize:"14px",fontFamily:"inherit"});let r=document.createElement("button");r.textContent="\u53D1\u8868\u8BC4\u8BBA",Object.assign(r.style,{width:"calc(100% - "+(t?"32px":"24px")+")",margin:t?"0 16px 16px":"0 12px 8px",padding:t?"12px 0":"6px 0",border:"none",background:"#f56c6c",color:"#fff",cursor:"pointer",borderRadius:"4px",fontSize:t?"16px":"14px",fontWeight:"500"}),r.onclick=async function(){let C=d.value.trim();if(!(!C||p==null))try{let g={"Content-Type":"application/json"};typeof window<"u"&&window.PARANOTE_TOKEN&&(g["X-Paranote-Token"]=window.PARANOTE_TOKEN),await fetch(v+"/api/v1/comments",{method:"POST",headers:g,body:JSON.stringify({siteId:S,workId:z,chapterId:O,paraIndex:p,content:C})}),d.value="",await L(),I(),await R(p,i,h.headerCount)}catch(g){console.error("post comment failed",g)}};let f=document.createElement("div");Object.assign(f.style,{padding:t?"14px 16px":"12px 16px",borderTop:"1px solid #e5e5e5",background:"#fafafa"});let m=document.createElement("div");m.style.cssText="display: flex; align-items: center; margin-bottom: 10px;";let b=document.createElement("div");b.style.cssText=`
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f0f0f0;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      font-size: 14px;
      margin-right: 10px;
      flex-shrink: 0;
      border: 1px solid #e5e5e5;
    `,b.textContent="\u6211";let T=document.createElement("span");return T.style.cssText="color: #999; font-size: 13px;",T.textContent="\u5199\u4E0B\u4F60\u7684\u60F3\u6CD5...",m.appendChild(b),m.appendChild(T),d.placeholder="\u5199\u4E0B\u4F60\u7684\u60F3\u6CD5...",Object.assign(d.style,{width:"100%",height:t?"90px":"70px",boxSizing:"border-box",margin:"0",padding:"10px 12px",border:"1px solid #e0e0e0",borderRadius:"4px",fontSize:"13px",fontFamily:"inherit",background:"#fff",resize:"none",transition:"border-color 0.15s"}),d.addEventListener("focus",function(){d.style.borderColor="#f56c6c",d.style.outline="none"}),d.addEventListener("blur",function(){d.style.borderColor="#e0e0e0"}),Object.assign(r.style,{width:"100%",margin:"10px 0 0",padding:t?"10px 0":"8px 0",border:"none",background:"#f56c6c",color:"#fff",cursor:"pointer",borderRadius:"4px",fontSize:t?"15px":"14px",fontWeight:"500",transition:"all 0.15s"}),r.addEventListener("mouseenter",function(){r.style.background="#ff4757"}),r.addEventListener("mouseleave",function(){r.style.background="#f56c6c"}),f.appendChild(m),f.appendChild(d),f.appendChild(r),e.append(o,i,f),{container:e,list:i,headerCount:o.querySelector(".na-comment-header-count")}}let j=null;async function L(){try{let e=v+"/api/v1/comments?siteId="+encodeURIComponent(S)+"&workId="+encodeURIComponent(z)+"&chapterId="+encodeURIComponent(O);return j=(await(await fetch(e)).json()).commentsByPara||{},j}catch(e){return console.error("load comments failed",e),{}}}function W(e){try{let s=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(window.atob(s).split("").map(function(c){return"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(n)}catch{return null}}async function R(e,o,s){let n=(j||{})[String(e)]||[];o.innerHTML="";let c=!1,a=null;if(typeof window<"u"&&window.PARANOTE_TOKEN){a=window.PARANOTE_TOKEN;let i=W(a);i&&(i.role==="admin"||i.isAdmin===!0)&&(c=!0)}if(s&&(s.textContent=n.length>0?n.length+"\u6761":""),!n.length){let i=document.createElement("div");i.style.cssText="padding: 60px 20px; text-align: center; color: #999; font-size: 13px; background: #fff;",i.innerHTML='<div style="margin-bottom: 8px; font-size: 32px; opacity: 0.5;">\u{1F4AC}</div><div>\u8FD8\u6CA1\u6709\u4EBA\u53D1\u8868\u8BC4\u8BBA</div>',o.appendChild(i);return}n.forEach(function(i,d){let r=document.createElement("div");r.className="na-comment-item",Object.assign(r.style,{padding:t?"14px 16px":"12px 16px",borderBottom:d<n.length-1?"1px solid #f0f0f0":"none",background:"#fff",transition:"background 0.15s",position:"relative"});let f=document.createElement("div");f.style.cssText="display: flex; align-items: center; margin-bottom: 8px;";let m=document.createElement("div"),b=i.userName||i.userId||"\u533F\u540D",T=b.length>0?b.charAt(0):"\u533F";m.style.cssText=`
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #f0f0f0;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        font-size: 12px;
        margin-right: 8px;
        flex-shrink: 0;
        border: 1px solid #e5e5e5;
      `,m.textContent=T;let C=document.createElement("div");C.style.cssText="flex: 1; min-width: 0;";let g=document.createElement("span");g.style.cssText="font-weight: 500; color: #333; font-size: 13px; margin-right: 8px;",g.textContent=b;let N=document.createElement("span");N.style.cssText="font-size: 11px; color: #999;";let B=i.createdAt?new Date(i.createdAt).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"";N.textContent=B,C.appendChild(g),C.appendChild(N),f.appendChild(m),f.appendChild(C);let H=document.createElement("div");H.style.cssText="color: #333; font-size: 13px; line-height: 1.7; margin-left: 36px; word-break: break-word; padding-top: 4px;",H.textContent=i.content;let A=document.createElement("div");if(A.style.cssText="display: flex; justify-content: flex-end; align-items: center; margin-top: 4px;",c){let l=document.createElement("button");l.innerHTML="\u5220\u9664",l.style.cssText="border:none; background:transparent; cursor:pointer; color:#999; font-size:12px; margin-right: 12px;",l.onmouseenter=()=>l.style.color="#f56c6c",l.onmouseleave=()=>l.style.color="#999",l.onclick=async function(){if(confirm("\u786E\u5B9A\u5220\u9664\u8FD9\u6761\u8BC4\u8BBA\u5417\uFF1F"))try{let x={"Content-Type":"application/json"};a&&(x["X-Paranote-Token"]=a),(await fetch(v+"/api/v1/comments",{method:"DELETE",headers:x,body:JSON.stringify({siteId:S,workId:z,chapterId:O,commentId:i.id})})).ok?(await L(),I(),await R(e,o,s)):alert("\u5220\u9664\u5931\u8D25\uFF0C\u53EF\u80FD\u662F\u6743\u9650\u4E0D\u8DB3")}catch(x){console.error(x),alert("\u7F51\u7EDC\u9519\u8BEF")}},A.appendChild(l)}let u=document.createElement("button"),U=i.likes||0;u.innerHTML=`<span style="font-size:14px">\u{1F44D}</span> <span style="margin-left:4px">${U}</span>`,u.style.cssText="border:none; background:transparent; cursor:pointer; color:#999; font-size:12px; display:flex; align-items:center; padding: 2px 6px;",u.onmouseenter=()=>u.style.color="#f56c6c",u.onmouseleave=()=>u.style.color="#999",u.onclick=async function(){try{let l={"Content-Type":"application/json"};a&&(l["X-Paranote-Token"]=a);let x=await fetch(v+"/api/v1/comments/like",{method:"POST",headers:l,body:JSON.stringify({siteId:S,workId:z,chapterId:O,commentId:i.id})});if(x.status===401){alert("\u8BF7\u767B\u5F55\u540E\u518D\u70B9\u8D5E");return}if(x.status===400){alert("\u60A8\u5DF2\u7ECF\u70B9\u8FC7\u8D5E\u4E86");return}if(x.ok){let P=await x.json();u.innerHTML=`<span style="font-size:14px">\u{1F44D}</span> <span style="margin-left:4px; color:#f56c6c">${P.likes}</span>`}}catch(l){console.error(l)}},A.appendChild(u),r.appendChild(f),r.appendChild(H),r.appendChild(A),t||(r.addEventListener("mouseenter",function(){r.style.background="#fafafa"}),r.addEventListener("mouseleave",function(){r.style.background="#fff"})),o.appendChild(r)})}function I(){k.forEach(function(e,o){let s=(j||{})[String(o)]?.length||0,n=e.querySelector(".na-comment-count");n||(n=document.createElement("span"),n.className="na-comment-count",e.appendChild(n));let c=p===o,a=c?"#f56c6c":"#999",i=c?"#f56c6c":"#e0e0e0";Object.assign(n.style,{display:"inline-block",marginLeft:t?"8px":"6px",padding:"0 4px",fontSize:t?"11px":"10px",color:a,background:"#fff",border:`1px solid ${i}`,borderRadius:"2px",cursor:"pointer",fontWeight:"500",minWidth:"18px",height:"18px",lineHeight:"16px",textAlign:"center",verticalAlign:"middle",touchAction:"manipulation",transition:"all 0.15s ease",boxSizing:"border-box"}),n.textContent=s,n.title=s+" \u6761\u8BC4\u8BBA",n.style.fontSize=t?"11px":"10px",t||(n.onmouseenter=function(){n.style.borderColor="#f56c6c",n.style.color="#f56c6c"},n.onmouseleave=function(){n.style.borderColor=i,n.style.color=a})})}k.forEach(function(e,o){e.dataset.naIndex=String(o),Object.assign(e.style,{cursor:"pointer",position:"relative",padding:t?"8px 0":"4px 0",borderRadius:"4px",transition:"all 0.2s",WebkitTapHighlightColor:"transparent",touchAction:"manipulation"}),t||(e.addEventListener("mouseenter",function(){p!==o&&(e.style.background="rgba(0, 0, 0, 0.02)")}),e.addEventListener("mouseleave",function(){p!==o&&(e.style.background="transparent",e.style.textDecoration="none")}));let s=async function(n){p!==null&&k[p]&&(k[p].style.textDecoration="none",k[p].style.background="transparent"),p=o,e.style.textDecoration="underline",e.style.textDecorationColor="#f56c6c",e.style.textDecorationThickness=t?"2px":"1.5px",e.style.textUnderlineOffset="2px",e.style.background="transparent",I(),h.container.style.display="flex",t&&(y.style.display="block",h.container.scrollTop=0),await R(o,h.list,h.headerCount)};e.onclick=s,t&&e.addEventListener("touchend",function(n){n.preventDefault(),s(n)},{passive:!1})}),L().then(function(){I()})})();})();
