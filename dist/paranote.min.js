var ParaNoteEmbed=(()=>{(function(){let T=document.currentScript;if(!T)return;console.log("ParaNote: Script loaded");let z=T.dataset.siteId||"default-site",v=T.getAttribute("data-api-base");v===null&&(v=T.src&&new URL(T.src).origin.replace(/\/$/,"")||"");function F(){let w=document.querySelector("[data-na-root]");if(console.log("ParaNote: Checking root...",w),!w){console.log("ParaNote: Root not found, waiting for DOMContentLoaded..."),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",F):console.warn("ParaNote: DOM loaded but root still missing");return}if(w.dataset.paranoteInitialized){console.log("ParaNote: Already initialized");return}w.dataset.paranoteInitialized="true";let j=w.dataset.workId||"default-work",R=w.dataset.chapterId||w.dataset.ChapterId||"default-chapter",m=w.querySelectorAll("p");if(console.log(`ParaNote: Found ${m.length} paragraphs`),!m.length){console.warn("ParaNote: No paragraphs found in root");return}let d=null,x=window.innerWidth<=768||"ontouchstart"in window,C=document.createElement("div");C.className="na-overlay",Object.assign(C.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0,0,0,0.5)",zIndex:99998,display:"none"}),C.onclick=function(){g.container.style.display="none",C.style.display="none"},document.body.appendChild(C);let g=K();document.body.appendChild(g.container);function K(){let t=document.createElement("div");t.className="na-sidebar";let e={bg:"#f7f7f7",cardBg:"#ffffff",text:"#333",meta:"#707070",border:"#dbdbdb",primary:"#bd1c2b",shadow:"0 4px 12px rgba(0,0,0,0.15)"},a=document.createElement("style");a.textContent=`
            @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
            @keyframes slideLeft { from { transform: translateX(100%); } to { transform: translateX(0); } }
        `,document.head.appendChild(a),x?Object.assign(t.style,{position:"fixed",bottom:"0",left:"0",right:"0",width:"100%",maxHeight:"85vh",background:e.bg,borderTop:`1px solid ${e.border}`,borderTopLeftRadius:"12px",borderTopRightRadius:"12px",boxShadow:"0 -4px 20px rgba(0,0,0,0.15)",fontSize:"14px",display:"none",flexDirection:"column",zIndex:99999,overflow:"hidden",fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif",animation:"slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)"}):Object.assign(t.style,{position:"fixed",top:"0",right:"0",width:"380px",height:"100vh",background:e.bg,borderLeft:`1px solid ${e.border}`,boxShadow:"-2px 0 12px rgba(0,0,0,0.05)",fontSize:"14px",display:"none",flexDirection:"column",zIndex:99999,overflow:"hidden",fontFamily:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif",animation:"slideLeft 0.3s cubic-bezier(0.16, 1, 0.3, 1)"});let n=document.createElement("div");Object.assign(n.style,{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 16px",borderBottom:`1px solid ${e.border}`,background:e.cardBg,color:e.text,flexShrink:0});let s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="8px";let f=document.createElement("span");f.innerHTML="\u{1F4DD}";let p=document.createElement("span");p.textContent="Annotations",p.style.fontWeight="600",p.style.fontSize="15px";let u=document.createElement("span");u.className="na-comment-header-count",Object.assign(u.style,{background:"#eee",color:"#666",padding:"2px 8px",borderRadius:"10px",fontSize:"12px",fontWeight:"500"}),s.append(f,p,u),n.appendChild(s);let o=document.createElement("button");o.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',Object.assign(o.style,{background:"transparent",border:"none",cursor:"pointer",color:"#999",padding:"4px",display:"flex",borderRadius:"4px",transition:"background 0.2s"}),o.onmouseenter=()=>o.style.background="#f0f0f0",o.onmouseleave=()=>o.style.background="transparent",o.onclick=function(){t.style.display="none",C.style.display="none"},n.appendChild(o);let E=document.createElement("div");Object.assign(E.style,{padding:"16px",flex:"1",overflowY:"auto",background:"#f7f7f7",display:"flex",flexDirection:"column",gap:"12px"});let l=document.createElement("div");Object.assign(l.style,{padding:"16px",borderTop:`1px solid ${e.border}`,background:e.cardBg,flexShrink:0});let c=document.createElement("textarea");c.placeholder="\u6DFB\u52A0\u8BC4\u8BBA...",Object.assign(c.style,{width:"100%",minHeight:"80px",boxSizing:"border-box",padding:"12px",border:`1px solid ${e.border}`,borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",resize:"vertical",outline:"none",transition:"border-color 0.2s, box-shadow 0.2s",marginBottom:"10px"}),c.onfocus=()=>{c.style.borderColor=e.primary,c.style.boxShadow="0 0 0 2px rgba(189, 28, 43, 0.1)"},c.onblur=()=>{c.style.borderColor=e.border,c.style.boxShadow="none"};let k=document.createElement("div");k.style.display="flex",k.style.justifyContent="flex-end";let i=document.createElement("button");return i.textContent="\u53D1\u5E03",Object.assign(i.style,{padding:"8px 20px",border:"none",background:e.primary,color:"#fff",cursor:"pointer",borderRadius:"20px",fontSize:"14px",fontWeight:"600",transition:"opacity 0.2s",boxShadow:"0 2px 4px rgba(189, 28, 43, 0.3)"}),i.onmouseenter=()=>i.style.opacity="0.9",i.onmouseleave=()=>i.style.opacity="1",i.onclick=async function(){let P=c.value.trim();if(!P||d==null)return;let D=(m[d]?H(m[d]):"").slice(0,32);try{i.textContent="\u53D1\u9001\u4E2D...",i.disabled=!0;let h={"Content-Type":"application/json"};typeof window<"u"&&window.PARANOTE_TOKEN&&(h["X-Paranote-Token"]=window.PARANOTE_TOKEN),await fetch(v+"/api/v1/comments",{method:"POST",headers:h,body:JSON.stringify({siteId:z,workId:j,chapterId:R,paraIndex:d,content:P,contextText:D})}),c.value="",await U(),I(),await $(d,E,g.headerCount)}catch(h){console.error("post comment failed",h),alert("\u53D1\u9001\u5931\u8D25")}finally{i.textContent="\u53D1\u5E03",i.disabled=!1}},k.appendChild(i),l.append(c,k),t.append(n,E,l),{container:t,list:E,headerCount:u}}function H(t){if(!t)return"";let e=t.cloneNode(!0),a=e.querySelector(".na-comment-count");return a&&a.remove(),e.textContent.trim()}let L=null;function J(t){let e={},a=[];return Object.values(t).forEach(n=>a.push(...n)),a.forEach(n=>{let s=n.paraIndex;if(n.contextText&&!H(m[s]).startsWith(n.contextText)){let u=-1;for(let o=0;o<m.length;o++)if(H(m[o]).startsWith(n.contextText)){u=o;break}u!==-1&&(s=u)}let f=String(s);e[f]||(e[f]=[]),e[f].push(n)}),e}async function U(){try{let t=v+"/api/v1/comments?siteId="+encodeURIComponent(z)+"&workId="+encodeURIComponent(j)+"&chapterId="+encodeURIComponent(R),a=await(await fetch(t)).json();return L=J(a.commentsByPara||{}),L}catch(t){return console.error("load comments failed",t),{}}}function X(t){try{let a=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(window.atob(a).split("").map(function(s){return"%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(n)}catch{return null}}async function $(t,e,a){let n=(L||{})[String(t)]||[];e.innerHTML="";let s=!1,f=!1,p=null,u=null;if(typeof window<"u"&&window.PARANOTE_TOKEN){p=window.PARANOTE_TOKEN;let o=X(p);o&&(o.role==="admin"||o.isAdmin===!0)&&(s=!0)}if(typeof window<"u"&&(u=window.TAPNOTE_EDIT_TOKEN||window.PARANOTE_EDIT_TOKEN||T.dataset.editToken,u&&(f=!0)),a&&(a.textContent=n.length>0?n.length+"\u6761":""),!n.length){let o=document.createElement("div");o.style.cssText="padding: 60px 20px; text-align: center; color: #999; font-size: 13px; background: #fff;",o.innerHTML='<div style="margin-bottom: 8px; font-size: 32px; opacity: 0.5;">\u{1F4AC}</div><div>\u8FD8\u6CA1\u6709\u4EBA\u53D1\u8868\u8BC4\u8BBA</div>',e.appendChild(o);return}n.forEach(function(o,E){let l=document.createElement("div");l.className="na-comment-card",Object.assign(l.style,{padding:"12px",marginBottom:"0",background:"#fff",borderRadius:"8px",border:"1px solid #eee",boxShadow:"0 1px 3px rgba(0,0,0,0.05)",transition:"transform 0.2s, box-shadow 0.2s",position:"relative"}),x||(l.addEventListener("mouseenter",()=>{l.style.transform="translateY(-1px)",l.style.boxShadow="0 4px 8px rgba(0,0,0,0.08)"}),l.addEventListener("mouseleave",()=>{l.style.transform="none",l.style.boxShadow="0 1px 3px rgba(0,0,0,0.05)"}));let c=document.createElement("div");c.style.cssText="display: flex; align-items: center; margin-bottom: 8px;";let k=document.createElement("div"),i=o.userName||o.userId||"\u533F\u540D",P=i.length>0?i.charAt(0).toUpperCase():"?",N=0;for(let r=0;r<i.length;r++)N=i.charCodeAt(r)+((N<<5)-N);let D=N%360;k.style.cssText=`
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: hsl(${D}, 60%, 85%);
            color: hsl(${D}, 60%, 30%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 10px;
            flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.05);
          `,k.textContent=P;let h=document.createElement("div");h.style.cssText="flex: 1; min-width: 0; display: flex; flex-direction: column;";let W=document.createElement("span");W.style.cssText="font-weight: 600; color: #333; font-size: 13px;",W.textContent=i;let _=document.createElement("span");_.style.cssText="font-size: 11px; color: #999; margin-top: 2px;";let Y=o.createdAt?new Date(o.createdAt).toLocaleString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"";_.textContent=Y,h.appendChild(W),h.appendChild(_),c.appendChild(k),c.appendChild(h);let A=document.createElement("div");A.style.cssText="color: #444; font-size: 14px; line-height: 1.6; word-break: break-word; padding-left: 42px;";let q=o.content;if(q.startsWith("> ")){let r=q.split(`
`),y=r[0].substring(2),S=r.slice(1).join(`
`).trim(),O=document.createElement("div");O.style.cssText="border-left: 3px solid #bd1c2b; padding-left: 8px; color: #777; margin-bottom: 6px; font-size: 13px; background: #f9f9f9; padding: 4px 8px; border-radius: 0 4px 4px 0;",O.textContent=y,A.appendChild(O);let M=document.createElement("div");M.textContent=S,A.appendChild(M)}else A.textContent=q;let B=document.createElement("div");if(B.style.cssText="display: flex; justify-content: flex-end; align-items: center; margin-top: 8px; padding-left: 42px;",s||f){let r=document.createElement("button");r.innerHTML="\u{1F5D1}\uFE0F",r.title=f?"\u5220\u9664\uFF08\u4F5C\u8005\uFF09":"\u5220\u9664\uFF08\u7BA1\u7406\u5458\uFF09",r.style.cssText="border:none; background:transparent; cursor:pointer; color:#aaa; font-size:14px; margin-right: 12px; transition:color 0.2s;",r.onmouseenter=()=>r.style.color="#bd1c2b",r.onmouseleave=()=>r.style.color="#aaa",r.onclick=async function(){if(confirm("\u786E\u5B9A\u5220\u9664\u8FD9\u6761\u8BC4\u8BBA\u5417\uFF1F"))try{let y={"Content-Type":"application/json"};p&&(y["X-Paranote-Token"]=p);let S={siteId:z,workId:j,chapterId:R,commentId:o.id};u&&(S.editToken=u);let O=await fetch(v+"/api/v1/comments",{method:"DELETE",headers:y,body:JSON.stringify(S)});if(O.ok)await U(),I(),await $(t,e,a);else{let M=await O.json().catch(()=>({}));alert(M.error||"\u5220\u9664\u5931\u8D25")}}catch(y){console.error(y),alert("\u5220\u9664\u5931\u8D25")}},B.appendChild(r)}let b=document.createElement("button"),G=o.likes||0;b.innerHTML=`<span style="font-size:14px">\u2764\uFE0F</span> <span style="margin-left:4px; font-size:12px;">${G||""}</span>`,b.style.cssText="border:none; background:transparent; cursor:pointer; color:#aaa; display:flex; align-items:center; padding: 2px 6px; transition:color 0.2s; border-radius:4px;",b.onmouseenter=()=>{b.style.color="#bd1c2b",b.style.background="#fff0f0"},b.onmouseleave=()=>{b.style.color="#aaa",b.style.background="transparent"},b.onclick=async function(){try{let r={"Content-Type":"application/json"};p&&(r["X-Paranote-Token"]=p);let y=await fetch(v+"/api/v1/comments/like",{method:"POST",headers:r,body:JSON.stringify({siteId:z,workId:j,chapterId:R,commentId:o.id})});if(y.status===401)return alert("\u8BF7\u767B\u5F55\u540E\u518D\u70B9\u8D5E");if(y.status===400)return alert("\u60A8\u5DF2\u7ECF\u70B9\u8FC7\u8D5E\u4E86");if(y.ok){let S=await y.json();b.innerHTML=`<span style="font-size:14px">\u2764\uFE0F</span> <span style="margin-left:4px; font-weight:bold; color:#bd1c2b">${S.likes}</span>`,b.style.color="#bd1c2b"}}catch(r){console.error(r)}},B.appendChild(b),l.appendChild(c),l.appendChild(A),l.appendChild(B),e.appendChild(l)})}function I(){m.forEach(function(t,e){let a=(L||{})[String(e)]?.length||0,n=t.querySelector(".na-comment-count");n||(n=document.createElement("span"),n.className="na-comment-count",t.appendChild(n));let s=d===e,f=s?"#f56c6c":"#999",p=s?"#f56c6c":"#e0e0e0";Object.assign(n.style,{display:"inline-block",marginLeft:x?"8px":"6px",padding:"0 4px",fontSize:x?"11px":"10px",color:f,background:"#fff",border:`1px solid ${p}`,borderRadius:"2px",cursor:"pointer",fontWeight:"500",minWidth:"18px",height:"18px",lineHeight:"16px",textAlign:"center",verticalAlign:"middle",touchAction:"manipulation",transition:"all 0.15s ease",boxSizing:"border-box"}),n.textContent=a,n.title=a+" \u6761\u8BC4\u8BBA",n.style.fontSize=x?"11px":"10px",x||(n.onmouseenter=function(){n.style.borderColor="#f56c6c",n.style.color="#f56c6c"},n.onmouseleave=function(){n.style.borderColor=p,n.style.color=f})})}m.forEach(function(t,e){t.dataset.naIndex=String(e),Object.assign(t.style,{cursor:"pointer",position:"relative",padding:x?"8px 0":"4px 0",borderRadius:"4px",transition:"all 0.2s",WebkitTapHighlightColor:"transparent",touchAction:"manipulation"}),x||(t.addEventListener("mouseenter",function(){d!==e&&(t.style.background="rgba(0, 0, 0, 0.02)")}),t.addEventListener("mouseleave",function(){d!==e&&(t.style.background="transparent",t.style.textDecoration="none")}));let a=async function(n){if(d!==null&&m[d]&&(m[d].style.textDecoration="none",m[d].style.background="transparent"),d===e&&g.container.style.display!=="none"){d=null,I(),g.container.style.display="none",x&&(C.style.display="none");return}d=e,t.style.textDecoration="underline",t.style.textDecorationColor="#f56c6c",t.style.textDecorationThickness=x?"2px":"1.5px",t.style.textUnderlineOffset="2px",t.style.background="transparent",I(),g.container.style.display="flex",x&&(C.style.display="block",g.container.scrollTop=0),await $(e,g.list,g.headerCount)};t.onclick=a,x&&t.addEventListener("touchend",function(n){},{passive:!1})}),U().then(function(){I()})}F()})();})();
